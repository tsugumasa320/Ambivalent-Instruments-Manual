# GroupDelay - All-Pass Disperser

**注意：このマニュアルはAI生成によって作られており、順次更新していく予定です。**

オールパスフィルタ群によるグループディレイ/位相分散エフェクトモジュールです。

## 概要

直列接続されたオールパスフィルタにより、周波数依存の位相遅延（グループディレイ）を生成します。これにより、トランジェントを豊かに変化させたり、ステレオイメージの広がりを向上させたりすることができます。

## クイックスタート

1. **オーディオ接続**: 左右のオーディオ入力に信号源を接続
2. **周波数調整**: FREQ ノブでフィルタの中心周波数を設定（20Hz〜20kHz）
3. **段数制御**: AMOUNT ノブでオールパスフィルタの段数を設定（0〜32）
4. **レゾナンス調整**: PINCH ノブで Q 値を設定（0.5〜16）

## パラメータ

### 基本制御

- **FREQ**: 中心周波数（20Hz〜20kHz、デフォルト1kHz）
  - ピッチシフトやエンベロープ制御に適用
  - CV 入力対応（±10V 範囲）
  - CV アテニュエーション付きトリム

- **AMOUNT**: オールパスフィルタ段数（0〜32、デフォルト4）
  - 0: スルー（位相遅延なし）
  - 増加: 段数が増えるほどグループディレイが増大
  - 小数点設定で滑らかに調整可能
  - CV 入力対応（±10V 範囲）
  - CV アテニュエーション付きトリム

- **PINCH**: フィルタ Q 値（0.5〜16、デフォルト0.3）
  - 0.5: 幅広いピーク、穏やかな響き
  - 大きい値: 狭いピーク、レゾナンスが強調
  - CV 入力対応（±10V 範囲）
  - CV アテニュエーション付きトリム

### 入出力

- **L IN**: 左チャンネル入力
- **R IN**: 右チャンネル入力
- **L OUT**: 左チャンネル出力
- **R OUT**: 右チャンネル出力

## 信号処理フロー

1. 入力信号の読み取り
2. **CV 前処理** （2025年改善）
   - 周波数 CV 入力に IIR ローパスフィルター適用（~2Hz カットオフ）
   - LFO などの低周波変調は通す、高周波ジッターは除去
   - 発振やアーティファクト防止
3. オールパスフィルタチェーンの処理
   - 指定段数のオールパスフィルタを直列接続
   - 小数点設定時に等パワーでブレンド
   - **段階的パラメータ更新** （2025年改善）
     - 毎フレーム 2 個のフィルターずつ周波数/Q を更新
     - 全 32 フィルターの更新に 16 フレーム要する
     - パラメータ変化の衝撃を分散して発振を抑制
4. ソフトクリッピング（±5V範囲）
5. 出力レベル LED による視覚フィードバック

## 安定性対策 （2025年改善）

グループディレイ効果を安定して利用するため、複数の対策が実装されています：

### 数値安全性
- **Double 精度フィルター計算**: 全フィルター係数を 64 ビット double 精度で管理
- **量子化ノイズ削減**: 32 段カスケード接続時の数値誤差を最小化

### 発振抑制メカニズム
1. **IIR LFO フィルター** (~2Hz カットオフ)
   - CV 入力の高周波ジッター除去
   - LFO（0.1～10Hz）は通す、ノイズ（高周波）は除去

2. **段階的パラメータ更新**
   - 毎フレーム 2 フィルターずつ更新
   - パラメータ変化を 16 フレームに分散
   - 係数更新衝撃の軽減

3. **高速係数平滑化**
   - 更新量: 0.5% per sample
   - ~180ms @ 44.1kHz で目標値に到達
   - クリック音やアーティファクト防止

4. **自動リセット**
   - NaN または Inf 出力検出時に自動リセット
   - 異常値の伝播防止

### 推奨設定
- **低リスク**: AMOUNT = 8～16 段（グループディレイ効果を維持、安定性向上）
- **中リスク**: AMOUNT = 16～24 段（より強いエフェクト、安定性は中程度）
- **高リスク**: AMOUNT = 24～32 段（最大エフェクト、LFO 使用時は注意）

### ⚠️ 周波数変調時の注意

**FREQ パラメータを過度に変調すると、フィルターが発振（自己発生音）することがあります。** 以下のガイドラインに従ってください：

**安全な周波数変調**:
- **LFO 周波数**: 0.1～5Hz の範囲内（IIR フィルターによる高周波ジッター除去）
- **変調スピード**: 緩やかな変化を心がける
- **CV 入力のアテニュエーション**: 過度な変調量を避ける（アテニュエーター使用）

**発振が発生した場合の対処**:
1. **FREQ を固定**: CV 接続を切断、手動ノブで固定値に設定
2. **AMOUNT を減らす**: 段数を 16 以下に低減
3. **CV 入力の振幅を減らす**: LFO 出力を減衰させる
4. **LFO 周波数を遅くする**: 0.1～1Hz の低速変調に変更

**注意**: AMOUNT が 24～32 段の高い設定で、高速な CV 変調（5Hz 以上）を行うと発振リスクが大幅に増加します。

## アプリケーション

- トランジェントの厚みと広がりの制御
- ステレオイメージの調整
- エフェクトの微調整
- クリエイティブな空間演出
- LFO 変調による動的空間エフェクト
