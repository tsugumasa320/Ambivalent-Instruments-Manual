# Delay Signal Processing

**Delayモジュール - 信号処理の詳細**

## 入力・出力範囲

**入力信号**
- 正常範囲: -5.0V ~ +5.0V（VCV Rack 標準）
- クリッピング防止: 内部処理により自動的に保護
- サンプリングレート: 44.1kHz, 48kHz, 96kHz に対応

**出力信号**
- 正常範囲: -5.0V ~ +5.0V（ソフトクリッピング防止）
- ドライ/ウェット・ミックス後の出力範囲をクランプ
- 有効値検出: NaNやinfを検出した場合 0.0V に設定

---

## フィードバック制御

### フィードバック量
- ユーザー入力: 0.0% ~ 95%
- CV入力: -95% ~ +95%（モード別スケーリング適用）
- 最大95%制限で無限ループ防止

### フィードバックスケーリング
各モードで異なるスケーリングを適用：
- **Reverseモード**: より少なめ（逆再生時のブーストアップ防止）
- **Ping-pongモード**: 標準
- **Repitch/Fadeモード**: 標準

### フィードバック保護
- 最大95%制限で無限ループ防止
- フィードバックスケーリングによる安全なレベル調整

### フィードバック・トーン制御
- フィードバックパスにトーン・フィルターを適用
- パラメータ別の周波数範囲をクランプ

---

## ドライ/ウェット・ミックス

### 等パワー・クロスフェード
```
dryGain = cos(kTwoPi * 0.25 * wetLevel)
wetGain = sin(kTwoPi * 0.25 * wetLevel)
output = drySignal * dryGain + wetSignal * wetGain
```

**メリット**:
- どのミックス位置でもRMSレベルが一定
- ソフトクリップ防止: 入力レベルが変化しても出力レベルは一定
- スムーズなフェード: クリックやポップ音なし

### ミックス範囲
- 完全ドライ: 原音のみ（wetLevel = 0）
- 完全ウェット: ディレイ音のみ（wetLevel = 1.0）
- ドライ/ウェット: 最も一般的な使用法
- 最大レベル: ドライとウェットが同時でも-5dB（等パワー）

---

## アンチエイリアシング・フィルター

### ローパス・フィルター（補間アーティファクト除去）
- 1次ローパス・フィルター
- カットオフ周波数: 可変（信号レベルに応じて変化）
- 目的: 急激なディレイタイム変更時の高周波ノイズ抑制

**適用箇所**
- Fadeモード: クロスフェード遷移時のノイズ抑制
- Repitchモード: ピッチシフト時のアーティファクト抑制
- Reverseモード: 逆再生時のスムージング

---

## クリッピング防止

### ソフトクリッピング
- 入力レベルを監視し、クリップを検出
- クリップした信号を非線形カーブで飽和（tanh）
- 効果: 聴聴可能な歪みを最小限に抑制

### 範囲保護
- 入力: -5.0V ~ +5.0V
- フィードバック: -5.0V ~ +5.0V
- 出力: -5.0V ~ +5.0V
- 内部処理: 全ての中間値で範囲保護

---

## トーン・フィルター

### 2バンド・ステート・バリアブル・フィルター（SVF）
- バンド1: 20Hz 〜 300Hz（低域）
- バンド2: 300Hz 〜 3kHz（中域）
- パラメータ: INTENSITY（TONEノブで制御）

### 周波数カーブ
- 対数スケールで制御
- INTENSITY = 0.2: 20Hz（最低）
- INTENSITY = 1.0: 20kHz（最高）

### トーン・カーブ
- 0.0 ~ 0.4: ローパス（低域強調、温かいサウンド）
- 0.5: フラット（トーン補正なし）
- 0.6 ~ 1.0: ハイパス（高域強調、明るいサウンド）

---

## モジュレーション（MODパラメータ）

### LFO（低周波発振器）モジュレーション
- モジュレーション深度: 0% ~ 100%（MODパラメータ）
- LFOレート: 現在は内部に固定（将来CVで制御可能に計画）
- モジュレーション対象: ディレイタイム
- エフェクト: テープのようなワウ＆フラッター・エフェクト

### LFO特性
- 深さが深いほど: より顕著なピッチ変動
- 深さが浅いほど: さり目立たない変調
- 使用例:
  - 浅い深度（<20%）: わかなうわらかなピッチ・バイブレーション
  - 中程度（50%）: テープのわずかなコーラス
  - 深い深度（>80%）: ヴラマチックなビブラート

---

## 使用例

### 基本的なディレイ・エフェクト
1. MODEボタンでFadeモード選択
2. TIMEを0.5秒に設定（12時位置 = 2.5秒）
3. FEEDBACKを0.5に設定（適度な反響）
4. WETを0.3に設定（30%ウェット、70%ドライ）
5. 入力信号に接続

### ハードウェア・ライクなピッチ・ベンド
1. MODEボタンでRepitchモード選択
2. TIMEを素早く変化（ピッチベンド効果）
3. フィードバックを高めに設定
4. モジュレーションを軽く適用（小さなLFO）

### アンビエント・サウンド
1. MODEボタンでFadeモード選択
2. TIMEを長めに設定
3. FEEDBACKを低めに設定
4. TONEをローパスに設定（暗いサウンド）
5. MODを適度に追加して空間的な広がりを演出

### ドラマチックなエフェクト
1. MODEボタンでRepitchモード選択
2. MODEをJumpトランジションに変更（右クリックメニュー）
3. TIMEを素早く変化してグリッチ効果作成
4. FEEDBACKを高く設定して無限反響

---

## 技術仕様

- サンプリングレート対応: 44.1kHz, 48kHz, 96kHz
- 補間方式: Hermite補間（Catmull-Romスプライン）
- 最大ディレイ長: 5秒
- 最小ディレイ長: 1ms
- チャンネル数: 2（ステレオ）
- CV入力: 4つ（TIME, FEEDBACK, WET, TONE）
- CPU使用率: 最小化（効率的なDSP実装）
